import fs from "node:fs";
import path from "node:path";
import { fileURLToPath } from "node:url";

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const presetsDir = path.resolve(__dirname, "../../../presets");
const outFile = path.resolve(__dirname, "../src/generated/preset-registry.ts");

// Discover all preset folders that contain a spec.ts
const presetNames = fs
  .readdirSync(presetsDir, { withFileTypes: true })
  .filter((entry) => {
    if (!entry.isDirectory()) return false;
    return fs.existsSync(path.join(presetsDir, entry.name, "spec.ts"));
  })
  .map((entry) => entry.name)
  .sort();

if (presetNames.length === 0) {
  console.warn("Warning: No presets found in presets/ directory.");
}

// Generate the registry source
const imports = presetNames
  .map(
    (name, i) =>
      `import { ${camelCase(name)}Preset } from "#presets/${name}/spec.js";`
  )
  .join("\n");

const registrations = presetNames
  .map((name) => `registerPreset(${camelCase(name)}Preset);`)
  .join("\n");

const source = `// This file is auto-generated by scripts/generate-preset-registry.js
// Do not edit manually. Add new presets to the presets/ directory instead.
import { registerPreset } from "../preset-runner.js";
${imports}

${registrations}
`;

fs.mkdirSync(path.dirname(outFile), { recursive: true });
fs.writeFileSync(outFile, source, "utf-8");

console.log(
  `Generated preset registry with ${presetNames.length} preset(s): ${presetNames.join(", ")}`
);

function camelCase(name) {
  return name.replace(/-([a-z])/g, (_, c) => c.toUpperCase());
}
